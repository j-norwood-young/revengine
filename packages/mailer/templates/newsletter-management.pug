extends layout.pug
block content
    - const now = new moment();
    - const last_week_filter = subscriber => moment(subscriber.date).diff(now, "day") > -7 && moment(subscriber.date).diff(now, "day") <= 0;
    - const prev_week_filter = subscriber => (moment(subscriber.date).diff(now, "day") > -14 && moment(subscriber.date).diff(now, "day") <= -7 )
    - const last_month_filter = subscriber => moment(subscriber.date).diff(now, "day") > -30
    - const prev_month_filter = subscriber => (moment(subscriber.date).diff(now, "day") > -60 && moment(subscriber.date).diff(now, "day") <= -30 )
    - const last_2month_filter = subscriber => (moment(subscriber.date).diff(now, "day") > -60)
    
    h1 RevEngine Newsletter Management Report - #{moment().format("D MMMM YYYY")}
    //- table
    //-     tr.cards
    //-         td
    //-             .card
    //-                 .card-title
    //-                     h2 All Lists
    //-                 .card-body
    //-                     .article
    //-                         .article-count.big_num= numberFormat.format(newsletter_data.lists.length)
    //-                         .article-title Lists
    //-                     .article
    //-                         .article-count.big_num= numberFormat.format(newsletter_data.subscribers.length)
    //-                         .article-title Unique Active Subscribers
    //-                     .article
    //-                         .article-count.big_num= numberFormat.format(active_last_week.length)
    //-                             if active_last_week > active_prev_week
    //-                                 .change.green &#9650;
    //-                             if active_last_week < active_prev_week
    //-                                 .change.red &#9660;
    //-                         .article-title New Unique Active Subscribers Last Seven Days
    //-                         | (Previous period #{ numberFormat.format(active_prev_week.length) })
    //-                     .article
    //-                         .article-count.big_num= numberFormat.format(active_last_month.length)
    //-                             if active_last_month > active_prev_month
    //-                                 .change.green &#9650;
    //-                             if active_last_month < active_prev_month
    //-                                 .change.red &#9660;
    //-                         .article-title New Unique Active Subscribers Last 30 Days 
    //-                         | (Previous period #{ numberFormat.format(active_prev_month.length) })
    table.report_table
        tr
            th(rowspan=2) List
            th(rowspan=2) Subscribers
            th(colspan=6) Last 7 days
            th(colspan=6) Last 30 days
        tr
            th Active
            th Unsubscribed
            th Change
            th Previous Change
            th Growth
            th Rate of Change
            th Active
            th Unsubscribed
            th Change
            th Previous Change
            th Growth
            th Rate of Change
        each list in newsletter_data.lists
            - const active = newsletter_data.active.find(list_subscriber => list_subscriber._id === list._id)
            if active
                - const unsubscribed = newsletter_data.unsubscribed.find(list_subscriber => list_subscriber._id === list._id)
                - console.log(unsubscribed)
                - const total_active = active.emails.length
                - const subscribers = active.emails.filter(last_2month_filter)
                - const active_last_week_count = subscribers.filter(last_week_filter).length
                - const unsubscribed_last_week_count = (unsubscribed) ? unsubscribed.emails.filter(last_week_filter).length : 0
                - const unsubscribed_prev_week_count = (unsubscribed) ? unsubscribed.emails.filter(prev_week_filter).length : 0
                - const active_prev_week_count = subscribers.filter(prev_week_filter).length
                - const last_week_delta = active_last_week_count - unsubscribed_last_week_count
                - const prev_week_delta = active_prev_week_count - unsubscribed_prev_week_count
                
                - const active_last_month_count = subscribers.filter(last_month_filter).length
                - const unsubscribed_last_month_count = (unsubscribed) ? unsubscribed.emails.filter(last_month_filter).length : 0
                - const unsubscribed_prev_month_count = (unsubscribed) ? unsubscribed.emails.filter(prev_month_filter).length : 0
                - const active_prev_month_count = subscribers.filter(prev_month_filter).length
                - const last_month_delta = active_last_month_count - unsubscribed_last_month_count
                - const prev_month_delta = active_prev_month_count - unsubscribed_prev_month_count
                if subscribers.length > 10
                    tr
                        td= list.name
                        td= numberFormat.format(total_active)
                        td= numberFormat.format(active_last_week_count)
                        td= numberFormat.format(unsubscribed_last_week_count)
                        td= numberFormat.format(last_week_delta)
                        td= numberFormat.format(prev_week_delta)
                        td= numberFormat.format(last_week_delta / (total_active - last_week_delta) * 100)
                            | %
                        td
                            - let roc_week = (last_week_delta - prev_week_delta)/prev_week_delta
                            if last_week_delta > prev_week_delta
                                .change.green &#9650;
                            if last_week_delta < prev_week_delta
                                .change.red &#9660;
                                - roc_week =  (prev_week_delta - last_week_delta)/prev_week_delta
                            if (last_week_delta)
                                | #{numberFormat.format(roc_week * 100)}%
                            else
                                | NA
                        
                        td= numberFormat.format(active_last_month_count)
                        td= numberFormat.format(unsubscribed_last_month_count)
                        td= numberFormat.format(last_month_delta)
                        td= numberFormat.format(prev_month_delta)
                        td= numberFormat.format(last_month_delta / (total_active - last_month_delta) * 100)
                            | %
                        td
                            - let roc_month = (last_month_delta - prev_month_delta)/prev_month_delta
                            if last_month_delta > prev_month_delta
                                .change.green &#9650;
                            if last_month_delta < prev_month_delta
                                .change.red &#9660;
                                - roc_month = (prev_month_delta - last_month_delta)/prev_month_delta
                            if (last_month_delta)
                                | #{numberFormat.format(roc_month * 100)}%
                            else
                                | NA
    p * Only lists with 50 or more active subscribers added in last 60 days displayed.