#!/bin/bash

# This script imports the Sailthru profile logs into MongoDB
# The following collection is used:
# filename | collection | indexes
# profile - sailthru_profile | id

# Vars
DIR=/data/dm-sailthru-data-explorer
SID=9943
DB=revengine-prod
HOSTS=rs1/rfvengine1,rfvengine2,rfvengine3,rfvengine4

# Find the most recent profile file
LATEST_FILE=$(ls -t ${DIR}/${SID}_profile.*.json | head -n 1)
if [ -z "$LATEST_FILE" ]; then
    echo "No profile files found in $DIR"
    exit 1
fi

echo "Found latest profile file: $LATEST_FILE"

# Calculate running time
start=$(date +%s.%N)

# Process the most recent profile file
echo "Importing $LATEST_FILE"
mongoimport --host=${HOSTS} --db=${DB} --collection=sailthru_profile --file=$LATEST_FILE --upsert --upsertFields id

# Fix date types
mongosh --host=${HOSTS} --eval 'db.sailthru_profile.updateMany({ create_date: { $type: "string" } }, [{ $set: { create_date: { $dateFromString: { dateString: "$create_date" } }, last_open: { $dateFromString: { dateString: "$last_open" } },last_click: { $dateFromString: { dateString: "$last_click" } },last_pageview: { $dateFromString: { dateString: "$last_pageview" } },signup_time: { $dateFromString: { dateString: "$signup_time" } },var_time: { $dateFromString: { dateString: "$var_time" } }, } }])' ${DB}

# Calculate running time
end=$(date +%s.%N)
runtime=$(awk "BEGIN {print $end - $start}")
echo "Runtime was $runtime" 